From ffa8821744e94eb17d2c4c3edec5e3b01b7caaa1 Mon Sep 17 00:00:00 2001
From: David Zbarsky <dzbarsky@gmail.com>
Date: Wed, 25 Feb 2026 05:03:24 -0500
Subject: [PATCH] Add crate_features_select and rustc_flags_select

---
 rs/extensions.bzl               | 17 ++++++++++++++---
 rs/private/annotations.bzl      |  2 ++
 rs/private/repository_utils.bzl |  8 +++++---
 rs/rust_crate.bzl               |  2 +-
 test/MODULE.bazel               |  6 ++++++
 5 files changed, 28 insertions(+), 7 deletions(-)

diff --git a/rs/extensions.bzl b/rs/extensions.bzl
index d7cbc32..866721f 100644
--- a/rs/extensions.bzl
+++ b/rs/extensions.bzl
@@ -542,12 +542,16 @@ def _generate_hub_and_spokes(
                 if version_key not in target_versions:
                     continue
                 target_versions = [version_key]
-            if not annotation.crate_features:
+            if not annotation.crate_features and not annotation.crate_features_select:
                 continue
             for version in target_versions:
                 features_enabled = feature_resolutions_by_fq_crate[_fq_crate(crate, version)].features_enabled
-                for triple in platform_triples:
-                    features_enabled[triple].update(annotation.crate_features)
+                if annotation.crate_features:
+                    for triple in platform_triples:
+                        features_enabled[triple].update(annotation.crate_features)
+                for triple, features in annotation.crate_features_select.items():
+                    if triple in features_enabled:
+                        features_enabled[triple].update(features)
 
     _date(mctx, "set up initial deps!")
 
@@ -622,6 +626,7 @@ crate.annotation(
             build_script_tools_select = annotation.build_script_tools_select,
             build_script_env_select = annotation.build_script_env_select,
             rustc_flags = annotation.rustc_flags,
+            rustc_flags_select = annotation.rustc_flags_select,
             data = annotation.data,
             deps = annotation.deps,
             crate_tags = annotation.tags,
@@ -1154,6 +1159,9 @@ _annotation = tag_class(
         "crate_features": attr.string_list(
             doc = "A list of strings to add to a crate's `rust_library::crate_features` attribute.",
         ),
+        "crate_features_select": attr.string_list_dict(
+            doc = "A list of strings to add to a crate's `rust_library::crate_features` attribute. Keys should be the platform triplet. Value should be a list of features.",
+        ),
         "data": _relative_label_list(
             doc = "A list of labels to add to a crate's `rust_library::data` attribute.",
         ),
@@ -1213,6 +1221,9 @@ _annotation = tag_class(
         "rustc_flags": attr.string_list(
             doc = "A list of strings to set on a crate's `rust_library::rustc_flags` attribute.",
         ),
+        "rustc_flags_select": attr.string_list_dict(
+            doc = "A list of strings to set on a crate's `rust_library::rustc_flags` attribute. Keys should be the platform triplet. Value should be a list of flags.",
+        ),
         # "shallow_since": attr.string(
         #     doc = "An optional timestamp used for crates originating from a git repository instead of a crate registry. This flag optimizes fetching the source code.",
         # ),
diff --git a/rs/private/annotations.bzl b/rs/private/annotations.bzl
index 58eb26a..980c725 100644
--- a/rs/private/annotations.bzl
+++ b/rs/private/annotations.bzl
@@ -14,8 +14,10 @@ _DEFAULT_CRATE_ANNOTATION = struct(
     deps = [],
     tags = [],
     crate_features = [],
+    crate_features_select = {},
     gen_binaries = [],
     rustc_flags = [],
+    rustc_flags_select = {},
     patch_args = [],
     patch_tool = None,
     patches = [],
diff --git a/rs/private/repository_utils.bzl b/rs/private/repository_utils.bzl
index e78f472..3b9d956 100644
--- a/rs/private/repository_utils.bzl
+++ b/rs/private/repository_utils.bzl
@@ -1,4 +1,3 @@
-
 load(":semver.bzl", "parse_full_version")
 
 def _platform(triple, use_experimental_platforms):
@@ -141,7 +140,7 @@ rust_crate(
     conditional_crate_features = {conditional_crate_features},
     crate_root = {crate_root},
     edition = {edition},
-    rustc_flags = {rustc_flags},
+    rustc_flags = {rustc_flags}{conditional_rustc_flags},
     tags = {tags},
     target_compatible_with = RESOLVED_PLATFORMS,
     links = {links},
@@ -175,6 +174,7 @@ rust_crate(
     build_deps, conditional_build_deps = render_select(attr.build_script_deps, attr.build_script_deps_select, use_experimental_platforms)
     build_script_data, conditional_build_script_data = render_select(attr.build_script_data, attr.build_script_data_select, use_experimental_platforms)
     build_script_tools, conditional_build_script_tools = render_select(attr.build_script_tools, attr.build_script_tools_select, use_experimental_platforms)
+    rustc_flags, conditional_rustc_flags = render_select(attr.rustc_flags, attr.rustc_flags_select, use_experimental_platforms)
     deps, conditional_deps = render_select(attr.deps + bazel_metadata.get("deps", []), attr.deps_select, use_experimental_platforms)
 
     conditional_build_script_env = render_select_build_script_env(attr.build_script_env_select, use_experimental_platforms)
@@ -195,7 +195,8 @@ rust_crate(
         conditional_crate_features = repr(conditional_crate_features),
         crate_root = repr(crate_root),
         edition = repr(edition),
-        rustc_flags = repr(attr.rustc_flags or []),
+        rustc_flags = repr(rustc_flags),
+        conditional_rustc_flags = " + " + conditional_rustc_flags if conditional_rustc_flags else "",
         tags = repr(attr.crate_tags),
         links = repr(links),
         build_script = repr(build_script),
@@ -230,6 +231,7 @@ common_attrs = {
     "build_script_tools_select": attr.string_list_dict(),
     "build_script_tags": attr.string_list(),
     "rustc_flags": attr.string_list(),
+    "rustc_flags_select": attr.string_list_dict(),
     "crate_tags": attr.string_list(),
     "data": attr.label_list(default = []),
     "deps": attr.string_list(default = []),
diff --git a/rs/rust_crate.bzl b/rs/rust_crate.bzl
index 4923ce2..37a440f 100644
--- a/rs/rust_crate.bzl
+++ b/rs/rust_crate.bzl
@@ -73,7 +73,7 @@ def rust_crate(
 
     if build_script:
         build_script_kwargs = dict(
-            build_deps = build_deps,
+            deps = build_deps,
             aliases = aliases,
             compile_data = compile_data,
             crate_name = "build_script_build",
diff --git a/test/MODULE.bazel b/test/MODULE.bazel
index 7429bde..2451f9f 100644
--- a/test/MODULE.bazel
+++ b/test/MODULE.bazel
@@ -114,7 +114,13 @@ crate.annotation(
     crate = "rustls",
     # Test for https://github.com/bazelbuild/rules_rust/issues/3626
     crate_features = ["fips"],
+    crate_features_select = {
+        "x86_64-unknown-linux-gnu": ["fips"],
+    },
     repositories = ["annotation_crate_features"],
+    rustc_flags_select = {
+        "x86_64-unknown-linux-gnu": ["--cfg=rules_rs_annotation_smoke"],
+    },
 )
 crate.annotation(
     # Smoketest that we do something reasonable with this attribute
